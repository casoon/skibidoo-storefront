---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCart } from "@/lib/api";
import { formatPrice } from "@/lib/format";

const cartId = Astro.cookies.get("cartId")?.value;
let cart = null;

if (cartId) {
  try {
    cart = await getCart(cartId);
  } catch {
    // Cart not found, will show empty
  }
}
---

<BaseLayout title="Warenkorb">
  <div class="mx-auto max-w-4xl px-4 py-8">
    <h1 class="mb-8 text-2xl font-bold text-gray-900">Warenkorb</h1>

    <div id="cart-content">
      {!cart || cart.items.length === 0 ? (
        <div class="rounded-lg bg-white p-12 text-center shadow">
          <svg class="mx-auto h-16 w-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <h2 class="mt-4 text-lg font-medium text-gray-900">Ihr Warenkorb ist leer</h2>
          <p class="mt-2 text-gray-500">Entdecken Sie unsere Produkte und fügen Sie diese hinzu.</p>
          <a
            href="/category/alle"
            class="mt-6 inline-block rounded-lg bg-primary-600 px-6 py-3 font-semibold text-white hover:bg-primary-700"
          >
            Jetzt shoppen
          </a>
        </div>
      ) : (
        <div class="grid gap-8 lg:grid-cols-3">
          <!-- Cart Items -->
          <div class="lg:col-span-2">
            <div class="rounded-lg bg-white shadow">
              {cart.items.map((item) => (
                <div class="flex gap-4 border-b p-4 last:border-0" id={`cart-item-${item.id}`}>
                  <div class="h-24 w-24 flex-shrink-0 overflow-hidden rounded-lg bg-gray-100">
                    {item.image ? (
                      <img src={item.image} alt={item.productName} class="h-full w-full object-cover" />
                    ) : (
                      <div class="flex h-full items-center justify-center text-gray-400">
                        <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                      </div>
                    )}
                  </div>

                  <div class="flex flex-1 flex-col">
                    <div class="flex justify-between">
                      <div>
                        <a href={`/products/${item.productSlug}`} class="font-medium text-gray-900 hover:text-primary-600">
                          {item.productName}
                        </a>
                        <p class="mt-1 text-sm text-gray-500">{formatPrice(item.unitPrice)} pro Stück</p>
                      </div>
                      <p class="font-semibold text-gray-900">{formatPrice(item.totalPrice)}</p>
                    </div>

                    <div class="mt-auto flex items-center justify-between">
                      <div class="flex items-center rounded-lg border">
                        <button
                          type="button"
                          class="px-3 py-1 text-gray-600 hover:text-gray-900"
                          hx-post="/api/cart/update"
                          hx-vals={`{"itemId": "${item.id}", "quantity": ${item.quantity - 1}}`}
                          hx-target="#cart-content"
                          hx-swap="innerHTML"
                        >-</button>
                        <span class="w-12 text-center">{item.quantity}</span>
                        <button
                          type="button"
                          class="px-3 py-1 text-gray-600 hover:text-gray-900"
                          hx-post="/api/cart/update"
                          hx-vals={`{"itemId": "${item.id}", "quantity": ${item.quantity + 1}}`}
                          hx-target="#cart-content"
                          hx-swap="innerHTML"
                        >+</button>
                      </div>

                      <button
                        type="button"
                        class="text-sm text-red-600 hover:text-red-700"
                        hx-post="/api/cart/remove"
                        hx-vals={`{"itemId": "${item.id}"}`}
                        hx-target="#cart-content"
                        hx-swap="innerHTML"
                      >
                        Entfernen
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- Order Summary -->
          <div>
            <div class="sticky top-24 rounded-lg bg-white p-6 shadow">
              <h2 class="mb-4 text-lg font-semibold">Zusammenfassung</h2>

              <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Zwischensumme</span>
                  <span>{formatPrice(cart.subtotal)}</span>
                </div>

                {cart.discount > 0 && (
                  <div class="flex justify-between text-green-600">
                    <span>Rabatt</span>
                    <span>-{formatPrice(cart.discount)}</span>
                  </div>
                )}

                <div class="flex justify-between">
                  <span class="text-gray-600">Versand</span>
                  <span>{cart.shipping > 0 ? formatPrice(cart.shipping) : "Wird berechnet"}</span>
                </div>

                <div class="border-t pt-3">
                  <div class="flex justify-between text-lg font-semibold">
                    <span>Gesamt</span>
                    <span>{formatPrice(cart.total)}</span>
                  </div>
                  <p class="mt-1 text-xs text-gray-500">inkl. MwSt.</p>
                </div>
              </div>

              <!-- Coupon -->
              <div class="mt-6">
                <form
                  hx-post="/api/cart/coupon"
                  hx-target="#cart-content"
                  hx-swap="innerHTML"
                  class="flex gap-2"
                >
                  <input
                    type="text"
                    name="code"
                    placeholder="Gutscheincode"
                    class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm"
                  />
                  <button
                    type="submit"
                    class="rounded-lg border border-primary-600 px-4 py-2 text-sm font-medium text-primary-600 hover:bg-primary-50"
                  >
                    Einlösen
                  </button>
                </form>
              </div>

              <a
                href="/checkout"
                class="mt-6 block rounded-lg bg-primary-600 py-3 text-center font-semibold text-white hover:bg-primary-700"
              >
                Zur Kasse
              </a>

              <a href="/category/alle" class="mt-4 block text-center text-sm text-gray-600 hover:text-primary-600">
                Weiter einkaufen
              </a>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</BaseLayout>
