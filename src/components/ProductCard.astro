---
import { formatPrice, formatBasePrice, formatDeliveryTime } from "@/lib/format";
import type { Product } from "@/lib/api";

interface Props {
  product: Product;
  /** Priority loading for above-the-fold images */
  priority?: boolean;
  /** Image sizes for srcset */
  sizes?: string;
}

const { 
  product, 
  priority = false,
  sizes = "(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw"
} = Astro.props;

const hasDiscount = product.compareAtPrice && product.compareAtPrice > product.price;
const discountPercent = hasDiscount
  ? Math.round((1 - product.price / product.compareAtPrice!) * 100)
  : 0;

// Generate srcset for responsive images
const generateSrcSet = (url: string) => {
  if (!url || url.startsWith("data:")) return undefined;
  const widths = [160, 320, 480, 640];
  return widths.map(w => `${url}?w=${w}&q=80 ${w}w`).join(", ");
};

const imageUrl = product.images?.[0]?.url;
const srcSet = imageUrl ? generateSrcSet(imageUrl) : undefined;
---

<article class="group relative rounded-lg bg-white p-4 shadow-sm transition-shadow hover:shadow-md">
  {hasDiscount && (
    <span class="absolute left-2 top-2 z-10 rounded bg-red-500 px-2 py-1 text-xs font-semibold text-white">
      -{discountPercent}%
    </span>
  )}

  <a href={`/products/${product.slug}`} class="block">
    <!-- Fixed aspect ratio container prevents CLS -->
    <div class="aspect-square overflow-hidden rounded-lg bg-gray-100">
      {imageUrl ? (
        <img
          src={imageUrl}
          srcset={srcSet}
          sizes={sizes}
          alt={product.images[0].alt || product.name}
          width="320"
          height="320"
          class="h-full w-full object-cover transition-transform group-hover:scale-105"
          loading={priority ? "eager" : "lazy"}
          decoding={priority ? "sync" : "async"}
          fetchpriority={priority ? "high" : "auto"}
        />
      ) : (
        <div class="flex h-full items-center justify-center text-gray-400">
          <svg class="h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      )}
    </div>

    <div class="mt-4">
      <!-- Fixed height for title prevents CLS -->
      <h3 class="line-clamp-2 min-h-[2.5rem] font-medium text-gray-900 group-hover:text-primary-600">
        {product.name}
      </h3>

      <div class="mt-2 flex items-baseline gap-2">
        <span class="text-lg font-bold text-gray-900">{formatPrice(product.price)}</span>
        {hasDiscount && (
          <span class="text-sm text-gray-500 line-through">{formatPrice(product.compareAtPrice!)}</span>
        )}
      </div>

      {product.basePrice && (
        <p class="mt-1 text-xs text-gray-500">
          ({formatBasePrice(product.basePrice)})
        </p>
      )}

      <!-- Fixed height container for delivery info -->
      <div class="mt-2 min-h-[1.25rem]">
        {product.deliveryTime && (
          <p class="text-xs text-green-600">
            {formatDeliveryTime(product.deliveryTime)}
          </p>
        )}
      </div>
    </div>
  </a>

  <button
    type="button"
    class="mt-3 w-full rounded-lg bg-primary-600 py-2 text-sm font-medium text-white transition-colors hover:bg-primary-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
    hx-post="/api/cart/add"
    hx-vals={JSON.stringify({ productId: product.id, quantity: 1 })}
    hx-target="#cart-count"
    hx-swap="innerHTML"
    hx-disabled-elt="this"
    hx-indicator=".htmx-indicator"
    disabled={product.stock === 0}
    aria-label={product.stock === 0 ? "Ausverkauft" : `${product.name} in den Warenkorb legen`}
  >
    {product.stock === 0 ? "Ausverkauft" : "In den Warenkorb"}
  </button>
</article>

<style>
  /* Ensure smooth image loading */
  img {
    content-visibility: auto;
  }
</style>
